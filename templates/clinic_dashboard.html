{% extends "base.html" %}
{% block content %}

<div class="flex flex-col md:flex-row justify-between items-center mb-6">
    <div class="text-center md:text-left">
        <h2 class="text-xl font-semibold text-pink-600">Vet Clinic Dashboard</h2>
        <p class="text-sm text-gray-500">Welcome, {{ clinic['name'] }}</p>
    </div>
</div>

<div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
    <a href="{{ url_for('clinic_dashboard', tab='profile') }}"
       class="block text-center py-2 rounded-lg font-medium shadow transition
       {{ 'bg-pink-600 text-white' if tab == 'profile' else 'bg-white text-gray-700 hover:bg-gray-50' }}">
        üè• Clinic Profile
    </a>

    <a href="{{ url_for('clinic_dashboard', tab='doctors') }}"
       class="block text-center py-2 rounded-lg font-medium shadow transition
       {{ 'bg-pink-600 text-white' if tab == 'doctors' else 'bg-white text-gray-700 hover:bg-gray-50' }}">
        üë®‚Äç‚öïÔ∏è Manage Doctors
    </a>

    <a href="{{ url_for('clinic_reports') }}"
       class="block text-center py-2 rounded-lg font-medium shadow bg-purple-100 text-purple-700 hover:bg-purple-200 border border-purple-200">
        üìä View Analytics
    </a>

    <a href="{{ url_for('clinic_dashboard', tab='appointments') }}"
       class="block text-center py-2 rounded-lg font-medium shadow transition
       {{ 'bg-pink-600 text-white' if tab == 'appointments' else 'bg-white text-gray-700 hover:bg-gray-50' }}">
        üìÖ Manage Appointments
    </a>
</div>

<div class="bg-white shadow-md rounded-lg p-6 border-l-4 border-pink-500 min-h-[450px]">

  {# -------------------- DOCTORS TAB -------------------- #}
  {% if tab == 'doctors' %}

    <div class="flex justify-between items-center mb-6">
        <h3 class="text-lg font-semibold text-gray-800">Doctor Profiles</h3>

        <a href="{{ url_for('add_doctor_form') }}"
           class="bg-pink-600 hover:bg-pink-700 text-white px-5 py-2 rounded-full text-sm font-medium shadow transition flex items-center gap-2">
            <span class="text-lg">+</span> Add Doctor
        </a>
    </div>

    {% if doctors %}
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
            {% for doctor in doctors %}
            <div class="border border-gray-200 rounded-xl p-5 hover:shadow transition bg-gray-50 relative">

                <span class="absolute top-3 right-3 bg-pink-100 text-pink-600 text-xs font-medium px-2 py-1 rounded">
                    {{ doctor['qualifications'] }}
                </span>

                <h4 class="text-lg font-semibold text-gray-800 mb-1">{{ doctor['name'] }}</h4>
                <p class="text-xs text-gray-500 mb-4">{{ doctor['email'] }}</p>

                <div class="flex justify-between items-center mb-4 bg-white p-2 rounded-lg border text-sm">
                    <span class="text-gray-400 uppercase">Fee</span>
                    <span class="font-semibold text-blue-600">‡ß≥{{ doctor['base_fee'] }}</span>
                </div>

                <div class="grid grid-cols-2 gap-3 text-sm">
                    <a href="{{ url_for('edit_doctor_form', doctor_id=doctor['id']) }}"
                       class="text-center bg-white border border-gray-300 text-gray-700 py-2 rounded hover:bg-gray-50 font-medium">
                        Edit
                    </a>

                    <button type="button"
                            class="w-full bg-red-50 border border-red-100 text-red-600 py-2 rounded hover:bg-red-100 font-medium"
                            data-delete-url="{{ url_for('delete_doctor_from_dashboard', doctor_id=doctor['id']) }}"
                            onclick="openDoctorDeleteModal(this);">
                      Delete
                    </button>
                </div>

                <div class="mt-3">
                    <a href="{{ url_for('clinic_doctor_appointments', doctor_id=doctor['id']) }}"
                       class="inline-block text-xs px-3 py-1 rounded-full bg-blue-50 text-blue-700 border border-blue-200">
                       View Appointments for this Doctor
                    </a>
                </div>

            </div>
            {% endfor %}
        </div>

    {% else %}
        <div class="text-center py-14 bg-gray-50 rounded-xl border-2 border-dashed border-gray-200">
            <h3 class="text-lg font-semibold text-gray-600">No doctors yet</h3>
            <p class="text-sm text-gray-400">Add your first doctor to get started.</p>
        </div>
    {% endif %}

  {# -------------------- PROFILE TAB -------------------- #}
  {% elif tab == 'profile' %}

    <div class="flex justify-between items-center mb-6">
        <h3 class="text-lg font-semibold text-gray-800">Clinic Details</h3>

        <a href="{{ url_for('edit_clinic_profile') }}"
           class="bg-gray-800 hover:bg-gray-900 text-white px-5 py-2 rounded-full font-medium text-sm">
           Edit Profile
        </a>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 bg-gray-50 p-6 rounded-xl border border-gray-200 text-sm">

        <div>
            <p class="text-xs text-gray-400 uppercase font-medium mb-1">Clinic Name</p>
            <p class="text-lg font-semibold text-gray-800">{{ clinic['name'] }}</p>
        </div>

        <div>
            <p class="text-xs text-gray-400 uppercase font-medium mb-1">License</p>
            <p class="text-base font-mono text-gray-700">{{ clinic['license_number'] }}</p>
        </div>

        <div>
            <p class="text-xs text-gray-400 uppercase font-medium mb-1">Email</p>
            <p class="text-base text-gray-800">{{ clinic['email'] }}</p>
        </div>

        <div>
            <p class="text-xs text-gray-400 uppercase font-medium mb-1">Contact</p>
            <p class="text-base text-gray-800">{{ clinic['contact_number'] or 'Not Set' }}</p>
        </div>

        <div class="md:col-span-2">
            <p class="text-xs text-gray-400 uppercase font-medium mb-1">Location</p>
            <p class="text-base text-gray-800">{{ clinic['location'] or 'Not Set' }}</p>
        </div>

    </div>

  {# -------------------- APPOINTMENTS TAB -------------------- #}
  {% elif tab == 'appointments' %}

    <div class="flex justify-between items-center mb-6">
        <h3 class="text-lg font-semibold text-gray-800">Manage Appointments</h3>
        <p class="text-xs text-gray-500">
          Requests for all doctors appear here.
        </p>
    </div>

    <!-- REQUESTS (new + reschedule_pending) -->
    <div class="mb-2">
      <h4 class="text-sm font-semibold text-gray-700 mb-2">Requests</h4>

      {% if appointments_requests %}
        <div class="space-y-3">
          {% for a in appointments_requests %}
            {% set s = (a['status'] or '')|lower %}
            <div class="bg-white border border-yellow-100 rounded-xl px-4 py-3 flex flex-col md:flex-row md:items-center md:justify-between gap-3 text-sm">
              <div>
                <p class="font-semibold text-gray-900">
                  {{ a['pet_name'] }}
                  <span class="text-gray-500">({{ a['owner_name'] }})</span>
                </p>

                <p class="text-xs text-gray-500 mt-0.5">
                  Doctor:
                  <span class="font-medium">{{ a['doctor_name'] }}</span>
                </p>

                <p class="text-[11px] text-gray-600 mt-0.5">
                  Pet:
                  {{ a['pet_animal_type'] or 'Unknown type' }}
                  {% if a['pet_breed'] %}
                    ‚Ä¢ Breed {{ a['pet_breed'] }}
                  {% endif %}
                  {% if a['pet_gender'] %}
                    ‚Ä¢ Gender {{ a['pet_gender'] }}
                  {% endif %}
                  {% if a['pet_age'] %}
                    ‚Ä¢ Age: {{ a['pet_age'] }}
                  {% endif %}
                  {% if a['pet_vaccination_status'] %}
                    ‚Ä¢ Vaccination: {{ a['pet_vaccination_status'] }}
                  {% endif %}
                </p>

                <p class="text-xs text-gray-500 mt-0.5">
                  {{ a['appointment_date'] }}
                </p>

                {% if s == 'reschedule_pending' %}
                  <p class="text-[11px] text-orange-600 mt-0.5">
                    Waiting for owner to confirm the new time.
                  </p>
                {% endif %}

              </div>

              <div class="flex flex-wrap gap-2 text-xs justify-end">
                {% if s != 'reschedule_pending' %}
                  <!-- Approve with cute modal -->
                  <button type="button"
                          class="px-3 py-1 rounded-full bg-green-500 hover:bg-green-600 text-white font-medium"
                          data-action-url="{{ url_for('clinic_appointment_action', appt_id=a['id'], action='approve') }}"
                          data-action-label="Approve"
                          onclick="openRequestActionModal(this);">
                    Approve
                  </button>
                {% endif %}

                <!-- Cancel with cute modal -->
                <button type="button"
                        class="px-3 py-1 rounded-full bg-red-500 hover:bg-red-600 text-white font-medium"
                        data-action-url="{{ url_for('clinic_appointment_action', appt_id=a['id'], action='cancel') }}"
                        data-action-label="Cancel"
                        onclick="openRequestActionModal(this);">
                  Cancel
                </button>

                {% if s != 'reschedule_pending' %}
                  <!-- Reschedule ‚Äì NO popup -->
                  <a href="{{ url_for('reschedule_appointment', appt_id=a['id']) }}"
                     class="px-3 py-1 rounded-full bg-yellow-400 hover:bg-yellow-500 text-gray-800 font-medium text-center">
                    Reschedule
                  </a>
                {% endif %}
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="text-xs text-gray-500 bg-gray-50 border border-dashed border-gray-200 rounded-xl px-4 py-3">
          No new or pending requests at the moment.
        </div>
      {% endif %}
    </div>

  {% endif %}

</div>

<!-- Hidden form for appointment request actions (approve/cancel) -->
<form id="request-action-form" method="POST" style="display:none;"></form>

<!-- Cute modal for Approve/Cancel in Requests -->
<div id="request-action-modal" class="modal-overlay" style="display:none;">
  <div class="modal-card">
    <div id="request-action-title" class="modal-title">Are you sure?</div>
    <div id="request-action-text" class="modal-text"></div>
    <div class="modal-buttons">
      <button id="request-action-confirm" class="modal-btn-danger">Yes</button>
      <button id="request-action-cancel" type="button" class="modal-btn-cancel">No</button>
    </div>
  </div>
</div>

<!-- Doctor delete modal (unchanged) -->
<form id="doctor-delete-form" method="POST" style="display:none;"></form>

<div id="doctor-delete-modal" class="modal-overlay" style="display:none;">
    <div class="modal-card">
        <div class="modal-title">Delete this doctor?</div>
        <div class="modal-text">
            This doctor profile will be permanently removed from your clinic.
        </div>
        <div class="modal-buttons">
            <button id="doctor-modal-confirm" class="modal-btn-danger">Yes, Delete</button>
            <button id="doctor-modal-cancel" class="modal-btn-cancel" type="button">No, Keep</button>
        </div>
    </div>
</div>

<style>
    .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.25);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 999;
    }
    .modal-card {
        background: #fffdfb;
        border-radius: 18px;
        padding: 18px 22px;
        min-width: 260px;
        max-width: 340px;
        border: 1px solid #ffd7b0;
        box-shadow: 0 10px 24px rgba(0,0,0,0.12);
        text-align: center;
    }
    .modal-title {
        font-weight: 600;
        margin-bottom: 8px;
        color: #c2185b;
    }
    .modal-text {
        font-size: 13px;
        color: #8c4b6e;
        margin-bottom: 14px;
    }
    .modal-buttons {
        display: flex;
        justify-content: center;
        gap: 10px;
    }
    .modal-btn-danger,
    .modal-btn-cancel {
        padding: 6px 14px;
        border-radius: 16px;
        border: none;
        font-size: 13px;
        cursor: pointer;
    }
    .modal-btn-danger {
        background: #e53935;
        color: #ffffff;
    }
    .modal-btn-cancel {
        background: #e3e3e3;
        color: #555;
    }
</style>

<script>
    /* Doctor delete modal */
    let doctorDeleteUrl = null;

    function openDoctorDeleteModal(button) {
        doctorDeleteUrl = button.getAttribute('data-delete-url');
        document.getElementById('doctor-delete-modal').style.display = 'flex';
    }

    document.getElementById('doctor-modal-confirm').onclick = function () {
        if (doctorDeleteUrl) {
            const form = document.getElementById('doctor-delete-form');
            form.action = doctorDeleteUrl;
            form.submit();
        }
    };

    document.getElementById('doctor-modal-cancel').onclick = function () {
        document.getElementById('doctor-delete-modal').style.display = 'none';
        doctorDeleteUrl = null;
    };

    /* Requests Approve/Cancel cute modal */
    let requestActionUrl = null;

    function openRequestActionModal(button) {
        requestActionUrl = button.getAttribute('data-action-url');
        const label = button.getAttribute('data-action-label') || 'Confirm';

        const titleEl = document.getElementById('request-action-title');
        const textEl  = document.getElementById('request-action-text');

        if (label === 'Approve') {
          titleEl.textContent = 'Approve this appointment?';
          textEl.textContent = 'The appointment will be marked as Approved and visible to the owner.';
        } else {
          titleEl.textContent = 'Cancel this appointment?';
          textEl.textContent = 'The appointment will be marked as Cancelled for both clinic and owner.';
        }

        document.getElementById('request-action-modal').style.display = 'flex';
    }

    document.getElementById('request-action-confirm').onclick = function (e) {
        e.preventDefault();
        if (requestActionUrl) {
            const form = document.getElementById('request-action-form');
            form.action = requestActionUrl;
            form.submit();
        }
    };

    document.getElementById('request-action-cancel').onclick = function () {
        document.getElementById('request-action-modal').style.display = 'none';
        requestActionUrl = null;
    };
</script>

{% endblock %}
