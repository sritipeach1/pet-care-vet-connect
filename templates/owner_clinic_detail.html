{% extends "base.html" %}
{% block content %}

<div class="max-w-5xl mx-auto">

  
  <div class="flex items-center justify-between mb-4">
    <div class="flex space-x-2 bg-blue-50 rounded-full px-1 py-1 text-sm border border-blue-100">
      <a href="{{ url_for('owner_search') }}"
         class="px-4 py-1 rounded-full text-blue-700 hover:bg-blue-100">
        Search
      </a>
      <a href="{{ url_for('owner_appointments') }}"
         class="px-4 py-1 rounded-full text-blue-700 hover:bg-blue-100">
        Appointment
      </a>
      <a href="{{ url_for('owner_dashboard', tab='pets') }}"
         class="px-4 py-1 rounded-full text-blue-700 hover:bg-blue-100">
        My Pets
      </a>
      <a href="{{ url_for('owner_dashboard', tab='owner') }}"
         class="px-4 py-1 rounded-full text-blue-700 hover:bg-blue-100">
        Profile
      </a>
      <span class="px-4 py-1 rounded-full text-gray-400 bg-blue-50 border border-dashed border-blue-200">
        PetBot (coming soon)
      </span>
    </div>

    <a href="{{ url_for('owner_search') }}"
       class="text-xs text-gray-500 hover:text-indigo-600 underline">
      &larr; Back to results
    </a>
  </div>

  <div class="bg-white rounded-2xl border border-blue-100 shadow-sm px-6 py-5 mb-5">
    <div class="flex justify-between items-start">
      <div>
        <div class="flex items-center space-x-2">
          <h2 class="text-xl font-semibold text-blue-900">{{ clinic['name'] }}</h2>
          <span class="text-yellow-500 text-sm">
            ‚òÖ {{ '%.1f'|format(clinic['clinic_rating'] or 0) }}
          </span>
        </div>

        <p class="text-xs text-gray-500 mt-1">
          üìç {{ clinic['location'] }}{% if clinic['contact_number'] %} &middot; ‚òé {{ clinic['contact_number'] }}{% endif %}
        </p>
        {% if clinic['email'] %}
          <p class="text-xs text-gray-400 mt-0.5">‚úâ {{ clinic['email'] }}</p>
        {% endif %}
        <p class="text-[11px] text-gray-400 mt-1">
          License: {{ clinic['license_number'] }}
        </p>
      </div>
    </div>
  </div>

  {% if doctors %}
    <div class="space-y-4">
      {% for d in doctors %}
        <div class="bg-blue-50 rounded-2xl border border-blue-100 px-5 py-4">
          <div class="flex justify-between items-start">
            <div>
              <h3 class="font-semibold text-blue-900">{{ d['name'] }}</h3>
              <p class="text-xs text-gray-500">{{ d['qualifications'] }}</p>
              <p class="text-xs text-gray-500 mt-1">‚úâ {{ d['email'] }}</p>
              <p class="text-xs text-gray-500 mt-1">
                Base Fee: <span class="font-semibold text-indigo-700">‡ß≥{{ d['base_fee'] }}</span>
              </p>
              {% if d['weekly_schedule'] %}
                <p class="text-[11px] text-gray-500 mt-2">
                  üóì {{ d['weekly_schedule'] }}
                </p>
              {% endif %}
            </div>
          </div>

          <form method="post"
                action="{{ url_for('book_appointment', clinic_id=clinic['id'], doctor_id=d['id']) }}"
                class="mt-4 grid grid-cols-1 md:grid-cols-4 gap-3 items-end bg-white rounded-2xl border border-blue-100 px-4 py-3 slot-form"
                data-doctor-id="{{ d['id'] }}">

            <div>
              <label class="block text-xs text-gray-500 mb-1">Pet</label>
              <select name="pet_id"
                      class="w-full border border-blue-200 rounded-full px-3 py-2 text-sm">
                <option value="">Choose pet...</option>
                {% for p in pets %}
                  <option value="{{ p['id'] }}">{{ p['name'] }} ({{ p['animal_type'] }})</option>
                {% endfor %}
              </select>
            </div>

            <div>
              <label class="block text-xs text-gray-500 mb-1">Date</label>
              <input type="date" name="date"
                     class="w-full border border-blue-200 rounded-full px-3 py-2 text-sm date-input">
            </div>

            <div class="md:col-span-2">
              <label class="block text-xs text-gray-500 mb-1">Available Time Slots</label>

              <input type="hidden" name="time" class="time-hidden" value="">

              <div class="slot-buttons flex flex-wrap gap-2"></div>

              <p class="slot-hint text-[11px] text-gray-400 mt-1 hidden">
                Tap a slot to select it.
              </p>

              <p class="slot-empty text-[12px] text-gray-500 mt-1 hidden">
                Pick a date to see available slots.
              </p>
            </div>

            <div class="flex justify-end mt-3 md:mt-0">
              <button type="submit"
                      class="submit-btn px-4 py-2 w-full md:w-auto rounded-full bg-gradient-to-r from-indigo-500 to-purple-500 text-white text-sm font-semibold shadow hover:shadow-md transition disabled:opacity-50 disabled:cursor-not-allowed"
                      disabled>
                Book Appointment
              </button>
            </div>
          </form>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="bg-white rounded-2xl border border-dashed border-blue-200 p-8 text-center text-sm text-gray-500">
      No doctors are listed for this clinic yet.
    </div>
  {% endif %}

</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const forms = document.querySelectorAll('.slot-form');

  forms.forEach((form) => {
    const doctorId   = form.dataset.doctorId;
    const dateInput  = form.querySelector('.date-input');
    const slotBox    = form.querySelector('.slot-buttons');
    const slotHint   = form.querySelector('.slot-hint');
    const slotEmpty  = form.querySelector('.slot-empty');
    const timeHidden = form.querySelector('.time-hidden');
    const submitBtn  = form.querySelector('.submit-btn');

    slotBox.innerHTML = '';
    slotHint.classList.add('hidden');
    slotEmpty.classList.remove('hidden');
    submitBtn.disabled = true;
    timeHidden.value = '';

    dateInput.addEventListener('change', async () => {
      const date = dateInput.value;
      slotBox.innerHTML = '';
      timeHidden.value = '';
      submitBtn.disabled = true;

      if (!date) {
        slotHint.classList.add('hidden');
        slotEmpty.classList.remove('hidden');
        slotEmpty.textContent = 'Pick a date to see available slots.';
        return;
      }

      try {
        const res = await fetch(`/owner/doctor/${doctorId}/slots?date=${encodeURIComponent(date)}`, {
          headers: { 'Accept': 'application/json' }
        });
        const slots = await res.json();

        if (!Array.isArray(slots) || slots.length === 0) {
          slotHint.classList.add('hidden');
          slotEmpty.classList.remove('hidden');
          slotEmpty.textContent = 'No slots available for this date.';
          return;
        }

        slotEmpty.classList.add('hidden');
        slotHint.classList.remove('hidden');
        slots.forEach((t) => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.dataset.time = t;
          btn.className = 'slot-btn px-3 py-1 rounded-full border border-indigo-300 text-xs text-indigo-700 bg-white hover:bg-indigo-50';
          btn.textContent = t;
          btn.addEventListener('click', () => {
            form.querySelectorAll('.slot-btn').forEach(b => {
              b.classList.remove('bg-indigo-600', 'text-white');
              b.classList.add('bg-white', 'text-indigo-700');
            });
            btn.classList.remove('bg-white', 'text-indigo-700');
            btn.classList.add('bg-indigo-600', 'text-white');
            timeHidden.value = t;
            submitBtn.disabled = false;
          });
          slotBox.appendChild(btn);
        });

      } catch (e) {
        slotHint.classList.add('hidden');
        slotEmpty.classList.remove('hidden');
        slotEmpty.textContent = 'Could not load slots. Try again.';
      }
    });
  });
});
</script>

{% endblock %}
